---
title: "EDA - Bottom Trawl Data 2008 - 2019"
author: "Erin LaBrecque"
date: "10/05/2020"
output: html_document
---


```{r setup, results='hide', message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 7, fig.height = 6.5)
library(knitr)
library(tidyverse)
library(fs)
library(lubridate)
library(sf)
library(leaflet)
library(kableExtra)

```

I exposed all the code so you can look at it if you want. You can run the .Rmd file in RStudio if you have the data files in a separate folder called `data`. 

### Loading the data
```{r readin, results='hide'}
dta <- dir_ls(path = "data") %>% 
  lapply(read_csv, col_types=cols(begindatetime=col_datetime("%d/%m/%Y-%H:%M:%S"))) %>% 
  bind_rows()

bad_dta <- dta %>% 
  filter(is.na(begindatetime))

meta_data <- c("cruiseid", "cruise", "station", "beginlon", "beginlat", "begindatetime", "stratum")
```         

These `r nrow(bad_dta)` observations combinations do not have a `begindatetime`, `latitude`, and `longitude`.
```{r missing_DT}
bad_dta %>% 
  select(cruiseid, cruise, station, stratum) %>% 
  kable(col.names = c("Cruise ID", "Cruise", "Station", "Stratum"),
               escape = FALSE) %>% 
   kable_styling(bootstrap_options = c("striped"), full_width = TRUE) 

```

# Creating a spatial data frame to plot all stations 
```{r spatial}
dta_sp <- dta %>%
  filter(!is.na(begindatetime)) %>% 
  select(all_of(meta_data)) %>% 
  st_as_sf(coords = c("beginlon", "beginlat"), crs = 4326)

# writing shapefile of stations
# commented out because there's no need to keep creating the same shapefile
# st_write(dta_sp, "shpfiles/bts_stations.shp")
```

# Basemap
```{r basemap}
base_map <- leaflet(options = leafletOptions(zoomControl = TRUE,
                                             zoomSnap = 0.1)) %>% 
  # add ocean basemap
  addProviderTiles("Esri.OceanBasemap") %>%

  # add another layer with place names
  addProviderTiles("Hydda.RoadsAndLabels", group = 'Place names') %>%
  
  # add graticules from a NOAA webserver - commented out becasue I think they
  # add clutter
  # addWMSTiles(
  #   "https://gis.ngdc.noaa.gov/arcgis/services/graticule/MapServer/WMSServer/",
  #   layers = c("1-degree grid", "5-degree grid"),
  #   options = WMSTileOptions(format = "image/png8", transparent = TRUE),
  #   attribution = NULL,group = 'Graticules') %>%
  
  # add a map scalebar
  addScaleBar(position = 'bottomright') %>% 

# focus map in a certain area / zoom level
  setView(lng = -72.201, lat = 39.308, zoom = 6)

# or set the boundary
#fitBounds(lng1 = -82.4, lat1 = 16.0, lng2 = -32.0, lat2 = 71.2)

base_map
```

# All Stations  
The dots have a degree of transparency, so darker areas indicate that area was sampled more than lighter areas.
```{r plot_all}
base_map %>% 
  addCircles(data = dta_sp) %>% 
  addMiniMap(position = "topleft", width = 125, height = 125)
```

# Station Data  
I was working under the assumption that `station` was a unique identifier. It is not. This is a plot of all the locations of station 37. 
```{r plot_station_exmpl}
to_plot <- dta %>% 
  filter(station == 38) %>% 
  select(all_of(meta_data)) %>% 
  st_as_sf(coords = c("beginlon", "beginlat"), crs = 4326)

base_map %>% 
  addCircles(data = to_plot) %>% 
  addMiniMap(position = "topleft", width = 125, height = 125)
```

# Data collection over time  
Each dot is the datetime and yearday of a station.  
Q: Should the February and June data be removed?
```{r date_over_time}
dta_1 <- dta %>%
  filter(!is.na(begindatetime)) %>% 
  select(all_of(meta_data)) %>% 
  mutate(yearday = yday(begindatetime),
         month = month(begindatetime, label = TRUE, abbr = FALSE),
         year = year(begindatetime))

start <- dta_1 %>% 
  filter(!is.na(begindatetime)) %>% 
  summarize(min = min(begindatetime))

dta_1 %>% 
ggplot(aes(begindatetime, yearday)) +
  geom_jitter() +
  annotate("text", label = "February", x = start$min, y = 50, size = 3, color = "black") +
  annotate("text", label = "March", x = start$min, y = 62, size = 3, color = "black") +
  annotate("text", label = "April", x = start$min, y = 104, size = 3, color = "black") +
  annotate("text", label = "May", x = start$min, y = 135, size = 3, color = "black") +
  annotate("text", label = "June", x = start$min, y = 155, size = 3, color = "black") +
  geom_hline(yintercept = c(60, 91, 121, 152), linetype = 2, color = "blue") +
  theme_bw() +
  scale_x_datetime() +
  ylim(45, 165) +
  labs(x = "Year",
       y = "Yearday",
       caption = "Blue dotted lines demarcate months.\n Leap year was not taken into account when determining yearday breaks for months.")

# great piece of code! :)
# position = position_dodge(preserve = "single")

```



